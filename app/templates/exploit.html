{% extends "main_navigation.html" %}

{% block title %}{{ lang.exploit_framework_title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3><i class="fas fa-skull-crossbones"></i> {{ lang.exploit_framework_title }}</h3>
            <span class="badge badge-info">{{ lang.metasploit_version_label }} {{ msf_version }}</span>
        </div>
        <div class="card-body">
            <div class="alert alert-danger" role="alert">
                ⚠️ <strong>{{ lang.exploit_warning_strong }}</strong> {{ lang.exploit_warning_text }}
            </div>
            
            <div class="row">
                <!-- Search Column -->
                <div class="col-md-5">
                    <h4><i class="fas fa-search"></i> {{ lang.search_exploit_modules_title }}</h4>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="module-search-query" placeholder="{{ lang.search_module_placeholder }}">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="button" id="search-modules-btn">
                                <span class="button-text">{{ lang.search_button }}</span>
                                <span class="spinner-border spinner-border-sm" style="display: none;" role="status"></span>
                            </button>
                        </div>
                    </div>
                    <div id="module-search-results" class="list-group" style="max-height: 600px; overflow-y: auto;">
                        <!-- Search results will be displayed here -->
                    </div>
                </div>

                <!-- Details & Options Column -->
                <div class="col-md-7">
                    <div id="module-details-section" style="display: none;">
                        <h4><i class="fas fa-info-circle"></i> {{ lang.module_details_title }}</h4>
                        <h5 id="module-fullname"></h5>
                        <p id="module-description"></p>
                        <hr>
                        <h5><i class="fas fa-cogs"></i> {{ lang.module_options_title }}</h5>
                        <form id="module-options-form">
                            <div id="options-container" style="max-height: 400px; overflow-y: auto;" class="p-2 border rounded">
                                <!-- Dynamic options will be loaded here -->
                            </div>
                            <button type="submit" class="btn btn-danger w-100 mt-3" id="run-exploit-btn">
                                <span class="button-text">{{ lang.run_exploit_button }}</span>
                                <span class="spinner-border spinner-border-sm" style="display: none;" role="status"></span>
                            </button>
                        </form>
                    </div>
                    <div id="exploit-placeholder" class="text-center text-muted pt-5">
                        <p><i class="fas fa-arrow-left fa-2x"></i></p>
                        <p>{{ lang.select_module_to_see_details }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Area -->
    <div id="results-area" class="card mt-4">
        <div class="card-header">
            <h4 class="mb-0"><i class="fas fa-terminal"></i> {{ lang.exploit_results_title }}</h4>
        </div>
        <div class="card-body">
            <div id="task-controls" style="display: none;">
                <span id="task-timer" class="me-3">00:00</span>
                <button id="cancel-button" class="btn btn-danger btn-sm">
                    <i class="fas fa-times-circle"></i> {{ lang.cancel_button }}
                </button>
            </div>
            <div id="analysis-in-progress" style="display: none;">
                <div class="d-flex align-items-center">
                    <strong id="task-status-message">{{ lang.processing_message }}</strong>
                    <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
                </div>
            </div>
            <pre id="output-display" class="mt-2">{{ lang.exploit_output_placeholder }}</pre>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const lang = {{ lang | tojson }};
$(document).ready(function() {
    // --- State Management for Multiple Tasks ---
    const taskStates = new Map(); // 'search', 'details', 'exploit'

    function clearTaskState(taskName) {
        const state = taskStates.get(taskName);
        if (!state) return;
        if (state.intervalId) clearInterval(state.intervalId);
        if (state.submitButton) {
            const button = $(state.submitButton);
            button.prop('disabled', false).find('.button-text').show();
            button.find('.spinner-border').hide();
        }
        taskStates.delete(taskName);
        updateGlobalTaskUI();
    }

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60).toString().padStart(2, '0');
        const sec = (seconds % 60).toString().padStart(2, '0');
        return `${min}:${sec}`;
    }

    function updateGlobalTaskUI() {
        if (taskStates.size > 0) {
            $('#results-area').show();
            $('#task-controls').show();
            $('#analysis-in-progress').show();
            // Update timer and message based on the most recent task
            const lastTask = Array.from(taskStates.values()).pop();
            const elapsedTime = Math.round((Date.now() - lastTask.startTime) / 1000);
            $('#task-timer').text(formatTime(elapsedTime));
            $('#task-status-message').text(lastTask.statusMessage || lang.processing_message);
        } else {
            $('#task-controls').hide();
            $('#analysis-in-progress').hide();
        }
    }

    function pollTaskStatus(taskName) {
        const state = taskStates.get(taskName);
        if (!state) return;

        updateGlobalTaskUI();

        $.ajax({
            url: `/task/status/${state.taskId}`,
            type: 'GET',
            success: function(response) {
                if (response.status === 'completed') {
                    state.renderFn(response.result.stdout);
                    clearTaskState(taskName);
                } else if (response.status === 'error') {
                    const errorText = response.result.stderr || (response.result && response.result.message) || lang.unknown_error_occurred;
                    state.errorFn(errorText);
                    clearTaskState(taskName);
                } else if (response.status === 'cancelled') {
                    state.errorFn(lang.task_was_cancelled);
                    clearTaskState(taskName);
                }
            },
            error: function(xhr) {
                state.errorFn(`${lang.error_polling_status}: ${xhr.responseText}`);
                clearTaskState(taskName);
            }
        });
    }

    function startTask(taskName, url, data, statusMessage, renderFn, errorFn, submitButton) {
        if (taskStates.has(taskName)) {
            alert(lang.task_already_running_wait_cancel);
            return;
        }

        $(submitButton).prop('disabled', true).find('.button-text').hide();
        $(submitButton).find('.spinner-border').show();

        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.task_id) {
                    const taskState = {
                        taskId: response.task_id,
                        startTime: Date.now(),
                        statusMessage: statusMessage,
                        renderFn: renderFn,
                        errorFn: errorFn,
                        submitButton: submitButton,
                        intervalId: setInterval(() => pollTaskStatus(taskName), 2000)
                    };
                    taskStates.set(taskName, taskState);
                    updateGlobalTaskUI();
                } else {
                    errorFn(response.error || lang.failed_to_start_task);
                    $(submitButton).prop('disabled', false).find('.button-text').show();
                    $(submitButton).find('.spinner-border').hide();
                }
            },
            error: function(xhr) {
                errorFn(`${lang.failed_to_start_task}: ${xhr.responseText}`);
                $(submitButton).prop('disabled', false).find('.button-text').show();
                $(submitButton).find('.spinner-border').hide();
            }
        });
    }

    // --- Rendering Functions ---
    function renderSearchResults(result) {
        const modules = JSON.parse(result);
        let resultsHtml = '';
        if (modules && modules.length > 0) {
            modules.forEach(function(module) {
                resultsHtml += `<a href="#" class="list-group-item list-group-item-action module-item" data-module-fullname="${module}">${module}</a>`;
            });
        } else {
            resultsHtml += `<div class="list-group-item">${lang.no_modules_found}</div>`;
        }
        $('#module-search-results').html(resultsHtml);
    }

    function renderSearchError(error) {
        $('#module-search-results').html(`<div class="list-group-item list-group-item-danger">${error}</div>`);
    }

    function renderModuleDetails(result) {
        const details = JSON.parse(result);
        $('#exploit-placeholder').hide();
        $('#module-details-section').show();
        $('#module-fullname').text(details.fullname);
        $('#module-description').text(details.description);

        let optionsHtml = '';
        
        // Create a dropdown for payloads if they exist
        if (details.payloads && details.payloads.length > 0) {
            optionsHtml += `
                <div class="form-group mb-2">
                    <label for="option_PAYLOAD" class="mb-0"><strong>PAYLOAD</strong> <span class="text-danger">*</span></label>
                    <select class="form-control form-control-sm" id="option_PAYLOAD" name="PAYLOAD">
            `;
            details.payloads.forEach(p => {
                optionsHtml += `<option value="${p}">${p}</option>`;
            });
            optionsHtml += `
                    </select>
                    <small class="form-text text-muted">Select the payload to use.</small>
                </div>
            `;
        }

        for (const optionName in details.options) {
            const option = details.options[optionName];
            const isRequired = option.required;
            const defaultValue = option.default || '';
            optionsHtml += `
                <div class="form-group mb-2">
                    <label for="option_${optionName}" class="mb-0"><strong>${optionName}</strong> ${isRequired ? '<span class="text-danger">*</span>' : ''}</label>
                    <input type="text" class="form-control form-control-sm" id="option_${optionName}" name="${optionName}" value="${defaultValue}" placeholder="${option.desc || ''}">
                    <small class="form-text text-muted">${option.desc || ''}</small>
                </div>
            `;
        }
        $('#options-container').html(optionsHtml);
        $('#output-display').text(lang.module_details_loaded);
    }

    function renderDetailsError(error) {
        $('#output-display').html(`<span class="text-danger">${error}</span>`);
    }

    function renderExploitResult(result) {
        $('#output-display').text(result);
    }

    function renderExploitError(error) {
        $('#output-display').html(`<span class="text-danger">${error}</span>`);
    }

    // --- Event Handlers ---
    $('#search-modules-btn').on('click', function() {
        const query = $('#module-search-query').val();
        if (!query) {
            renderSearchError(lang.search_query_empty_warning);
            return;
        }
        $('#module-search-results').html(''); // Clear previous results
        startTask('search', '/search_msf_modules', { query: query }, lang.searching_modules_message, renderSearchResults, renderSearchError, this);
    });

    $(document).on('click', '.module-item', function(e) {
        e.preventDefault();
        const moduleFullname = $(this).data('module-fullname');
        $('.module-item').removeClass('active');
        $(this).addClass('active');
        $('#output-display').text(lang.loading_module_details);
        startTask('details', '/get_msf_module_details', { module_fullname: moduleFullname }, lang.loading_module_details, renderModuleDetails, renderDetailsError, null);
    });

    $('#module-options-form').on('submit', function(event) {
        event.preventDefault();
        const moduleFullname = $('#module-fullname').text();
        if (!moduleFullname) {
            renderExploitError("No module selected.");
            return;
        }

        let options = {};
        $(this).serializeArray().forEach(item => {
            options[item.name] = item.value;
        });

        $('#output-display').text(lang.running_exploit_message);
        startTask('exploit', '/run_exploit', { module_fullname: moduleFullname, options: options }, lang.running_exploit_message, renderExploitResult, renderExploitError, this.querySelector('button[type="submit"]'));
    });

    $('#cancel-button').on('click', function() {
        // Cancel all running tasks
        taskStates.forEach((value, key) => {
            $.ajax({
                url: `/task/cancel/${value.taskId}`,
                type: 'POST'
            });
        });
    });
});
</script>
{% endblock %}
