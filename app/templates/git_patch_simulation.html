
{% extends "main_navigation.html" %}

{% block title %}{{ lang.git_patch_simulation_title | default('Fix Simulation') }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-file-code"></i> {{ lang.git_patch_simulation_title | default('Fix Simulation') }}</h3>
        </div>
        <div class="card-body">
            <a href="{{ url_for('main.git_patch_page') }}" class="btn btn-secondary mb-3"><i class="fas fa-arrow-left"></i> {{ lang.back_to_analysis | default('Back to Analysis') }}</a>
            <div id="diff-container"></div>
            <button id="downloadPatchButton" class="btn btn-success mt-3"><i class="fas fa-download"></i> {{ lang.git_patch_download_patch_button | default('Download Patch') }}</button>
            <button id="pushToRepoButton" class="btn btn-info mt-3"><i class="fas fa-code-branch"></i> {{ lang.git_patch_push_to_repo_button | default('Push to Repo') }}</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
<script>
    $(document).ready(function() {
        const diffString = `{{ diff_content | tojson }}`;
        const diff2htmlUi = new Diff2HtmlUI($('#diff-container')[0], diffString, {
            drawFileList: true,
            fileListToggle: false,
            fileListStartVisible: false,
            fileContentToggle: true,
            matching: 'lines',
            outputFormat: 'side-by-side',
            synchronisedScroll: true,
            highlight: true,
            renderNothingWhenEmpty: false,
        });
        diff2htmlUi.draw();
        diff2htmlUi.highlightCode();

        $('#downloadPatchButton').on('click', function() {
            const blob = new Blob([diffString], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gitgen-patch.diff';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        $('#pushToRepoButton').on('click', function() {
            const repoUrl = new URLSearchParams(window.location.search).get('repo_url');
            $(this).prop('disabled', true).text(lang.git_patch_creating_pr_button || 'Creating PR...');

            $.ajax({
                url: '/gitgen/api/v1/create-pull-request',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    repo_url: repoUrl, 
                    patch_content: diffString 
                }),
                success: function(response) {
                    if (response.pr_url) {
                        alert(`${lang.git_patch_pr_created_alert || 'Successfully created Pull Request:'} ${response.pr_url}`);
                        window.open(response.pr_url, '_blank');
                    } else {
                        alert(response.error || lang.git_patch_pr_creation_failed || 'Failed to create Pull Request.');
                    }
                },
                error: function(xhr, status, error) {
                    alert(`${lang.git_patch_pr_creation_failed_colon || 'PR creation failed:'} ${status} - ${error}`);
                },
                complete: function () {
                    $('#pushToRepoButton').prop('disabled', false).text(lang.git_patch_push_to_repo_button || 'Push to Repo');
                }
            });
        });
    });
</script>
{% endblock %}
